name: Screenshots

on:
  pull_request:
    branches:
      - master
      - dev
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  workflow_dispatch:

jobs:
  screenshots:
    name: Generate GUI Screenshots
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ !github.event.pull_request.draft }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install llvmpipe and lavapipe for offscreen canvas
        run: |
          sudo apt-get update -y -qq
          sudo apt-get install --no-install-recommends -y \
            ffmpeg \
            libegl1-mesa-dev \
            libgl1-mesa-dri \
            libxcb-xfixes0-dev \
            mesa-vulkan-drivers \
            xorg-dev \
            libx11-dev \
            libxcb1-dev \
            libxcb-glx0-dev

      - name: Setup uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          GIT_LFS_SKIP_SMUDGE=1 uv sync --all-extras
          uv pip install pytest pytest-xdist imageio

      - name: Show wgpu backend
        run: |
          uv run python -c "from tests.test_utils import get_wgpu_backend; print(get_wgpu_backend())"

      - name: Generate screenshots
        env:
          RENDERCANVAS_FORCE_OFFSCREEN: 1
          PYGFX_EXPECT_LAVAPIPE: true
          REGENERATE_SCREENSHOTS: 1
        run: |
          # Delete existing screenshots if they exist
          rm -rf tests/screenshots/*.png || true
          # Regenerate screenshots
          uv run pytest -v tests/test_graphics_screenshots.py

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gui-screenshots
          path: tests/screenshots/
          retention-days: 30

      - name: Comment on PR with screenshots
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const screenshotDir = 'tests/screenshots';
            let comment = '## ðŸ“¸ GUI Screenshots Generated\n\n';
            comment += 'Screenshots have been generated for the GUI changes. ';
            comment += 'Download the artifacts to review them.\n\n';

            if (fs.existsSync(screenshotDir)) {
              const files = fs.readdirSync(screenshotDir).filter(f => f.endsWith('.png'));
              if (files.length > 0) {
                comment += `Generated ${files.length} screenshot(s):\n`;
                files.forEach(file => {
                  comment += `- ${file}\n`;
                });
              }
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
